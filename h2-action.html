<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="./behaviors/ajax-behavior.html">
<link rel="import" href="./h2-form.html">
<link rel="import" href="./h2-dialog.html">

<!--

A magic component, which you can post a form or open a dialog.

```
// Immediately submit a form.
<h2-action context="{{ context }}" metadata="{{ metadata }}"></h2-action>

// Open a h2-dialog
<h2-action context="{{ context }}" metadata="{{ metadata1 }}"></h2-action>

```
```
context = {
  name: "WahsonLeung",
  phone: "15900000000"
}

metadata = {
    actionId: "record-add",
    actionName: "Add Record",
    operType: 1,
    formMeta: {
    formUrl: "/url-to-send-form",
    confirm: "Sure to submit?",
    fields: [
      {
        name: "name",
        label:"Name"
      },
      {
        name: "phone",
        label:"Phone"
      },
    ],
}

metadata1 = {
    actionId: "record-add",
    actionName: "Add Record",
    operType: 2,
    formMeta: {
    formUrl: "/url-to-send-form",
    confirm: "Sure to submit?",
    fields: [
      {
        name: "name",
        label:"Name"
      },
      {
        name: "phone",
        label:"Phone"
      },
    ],
}
```
-->
<dom-module id="h2-action">
    <template>
        <style>
            :host {
                display: inline-block;
                overflow: visible;
            }

            :host paper-button {
                width: inherit;
                height: inherit;
                margin: 0;
                background: #fff;
            }
        </style>
        <paper-button raised on-tap="submitOrOpenDialog">[[ metadata.actionName ]]</paper-button>
        <div id="form" hidden></div>
    </template>
    <script>
      /**
       * @customElement
       * @polymer
       * @demo demo/h2-action/index.html
       */
      class H2Action extends Polymer.mixinBehaviors([AjaxBehavior], Polymer.Element) {
        constructor() {
          super();
        }

        static get is() {
          return "h2-action";
        }

        static get properties() {
          return {
            metadata: {
              type: Object
            },

            context: {
              type: Object,
              observer: "__contextChange"
            },

            _dialog: {
              type: Object
            },

            _form: {
              type: Object
            }
          }
        }

        __contextChange() {
          this._dialog = null;
          this._form = null;
        }
        /**
         * When this.metadata.modelSrc is defined, fetch the new context.
         */
        fetchContext() {
          if (!this.metadata.modelSrc) return;
          // fetch model with modelSrc
          const data = {};

          if (this.metadata.modelQueryParams) {
            this.metadata.modelQueryParams.forEach(param => (data[param] = this.context[param]));
          }

          this.query({
            url: this.metadata.modelSrc,
            data: data
          }, (data) => {
            this._refreshContext(data);
          }, (err) => window.alert(JSON.stringify(err)));

        }

        /**
         * If this.metadata.operType == 1 submit a form
         * else if this.metadata.operType == 2  open a dialog.
         */
        submitOrOpenDialog() {
          if (this.metadata.operType == 1) {
            // If no <h2-form /> exists in #form component, then append one.
            this._form = this._form || this.$.form.appendChild(this._createForm());
            setTimeout(() => {
              this._form.submit();
            },0);

          } else if (this.metadata.operType == 2) {
            this.fetchContext();
            this._createDialog();
          }
        }

        _refreshContext(context) {
          this.context = context;
          this._form.set('context', context);
        }

        _createForm() {
          const form = document.createElement('h2-form');
          form.metadata = this.metadata.formMeta;
          form.context = this.context || {};
          form.addEventListener('h2-form-submitted', this._formSubmittedHandler.bind(this));
          return form;
        }

        _createDialog() {
          this._dialog = document.createElement('h2-dialog');
          document.body.appendChild(this._dialog);
          this._dialog.open();

          // make sure the dialog is opened smoothly
          setTimeout(() => {
            const form = this._createForm();
            form.slot = "container";
            this._form = form;
            this._dialog.appendChild(form);
            this._dialog.addEventListener('h2-dialog-closed', e => {
              this._form = null;
              this._dialog = null;
            });
          }, 0);

          return this._dialog;
        }

        _formSubmittedHandler(e) {

          e.stopPropagation();

          if (this._dialog) {
            this._dialog.close();
          }

          /**
           * @event form-submitted
           * Fire when the form submitted.
           */
          this.dispatchEvent(new CustomEvent("form-submitted", {
            bubbles: true, composed: true, detail: e.detail
          }));
        }

      }
      customElements.define(H2Action.is, H2Action);
    </script>
</dom-module>