<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="h2-form.html">
<dom-module id="h2-action">
    <template>
        <style>
            :host {
                display: inline-block;
                overflow: visible;
            }

            :host paper-button {
                width: inherit;
                height: inherit;
                margin: 0;
                background: #fff;
            }
        </style>
        <paper-button raised on-click="submitOrOpenDialog">[[ metadata.actionName ]]</paper-button>
        <div id="form" hidden></div>
    </template>
    <script>
      class H2Action extends Polymer.mixinBehaviors([CrudBehavior], Polymer.Element) {
        constructor() {
          super();
        }

        static get is() {
          return "h2-action";
        }

        static get properties() {
          return {
            metadata: {
              type: Object
            },
            model: {
              type: Object
            },
            _dialog: {
              type: Object
            },
            _form: {
              type: Object
            }
          }
        }

        fetchModel() {
          if (!this.metadata.modelSrc) return Promise.resolve();

          return new Promise((resolve, reject) => {
            // fetch model with modelSrc
            this.query(this.metadata.modelSrc, (data) => {
              this.model = data;
              resolve();
            }, reject);
          });
        }

        submitOrOpenDialog() {
          if (this.metadata.operType == 1) {
            // If no <h2-form /> exists in #form component, then append one.
            this._form = this._form || this.$.form.appendChild(this._createForm());
            this._form.submit();

          } else if (this.metadata.operType == 2) {
            this.fetchModel()
                .then(() => this._createDialog())
                .catch(err => window.alert(JSON.stringify(err)));
          }
        }

        _createForm() {
          const form = document.createElement('h2-form');
          form.metadata = this.metadata.formMeta;
          form.model = this.model;
          form.addEventListener('form-submitted', this._formSubmittedHandler.bind(this));
          return form;
        }

        _createDialog() {
          this._dialog = document.createElement('paper-dialog');

          this._dialog.appendChild(this._createForm());
          this._dialog.entryAnimation = "scale-up-animation";
          this._dialog.exitAnimation = "fade-out-animation";
          this._dialog.style.width = "85%";
          this._dialog.style.height = "80%";
          this._dialog.addEventListener('iron-overlay-closed', e => {
            setTimeout(() => {
              document.body.removeChild(this._dialog);
              this._dialog = undefined;
            }, 100);
          });

          document.body.appendChild(this._dialog);
          this._dialog.open();
        }

        _formSubmittedHandler(e) {

          e.stopPropagation();

          if (this._dialog) {
            this._dialog.close();
          }

          this.dispatchEvent(new CustomEvent("form-submitted", {
            bubbles: true, composed: true, detail: e.detail
          }));
        }

      }
      customElements.define(H2Action.is, H2Action);
    </script>
</dom-module>