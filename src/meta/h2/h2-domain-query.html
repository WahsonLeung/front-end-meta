<link rel="import" href="h2-form.html">
<link rel="import" href="h2-widget.html">
<dom-module id="h2-domain-query">
    <template>
        <div class="container">
            <template is="dom-repeat" items="{{ formMeta.fields }}" as="fieldMeta">
                <div>
                    <h2-widget
                            id="{{ getEditorId(fieldMeta.name) }}"
                            model="{{ model }}"
                            field-meta="{{ fieldMeta }}">
                    </h2-widget>
                </div>
            </template>
        </div>
        <div style="float:left;margin: 12px;">
            <paper-button raised on-click="submit">查询</paper-button>
            <paper-button raised on-click="reset">重置</paper-button>
        </div>
        <slot id="ext-condition" name="ext-condition"></slot>
    </template>
    <script>
      class H2DomainQuery extends H2Form {
        constructor() {
          super();
        }

        static get is() {
          return "h2-domain-query";
        }

        static get properties() {
          return {
            result: {
              type: Array,
              notify: true
            },
            formMeta: {
              type: Object
            },
            paging: {
              type: Object
            },
            extQueryCondition: {
              type: Object,
              value: function () {
                return {};
              }
            },
            queryAfterReset: {
              type: Boolean,
              value: false
            }
          }
        }

        static get observers() {
          return [
            'pagingChange(paging.start)'
          ];
        }

        pagingChange() {
          if (this.formMeta.paging && this.paging) {
            this.async(this.submit.bind(this), 0);
          }
        }

        ready() {
          super.ready();
          this.addEventListener('query-domain', e => {
            Object.assign(this.extQueryCondition, e.detail);
            this.submit();
          });
        }

        submit() {
          const param = this._requestBody();
          Object.assign(param, this.extQueryCondition);

          if (this.formMeta.paging && this.paging) {
            const {start, limit} = this.paging;
            param.start = start;
            param.limit = limit;
          }

          this.update(this.formMeta.formUrl, param, (data) => {
            this.result = data;
          });
        }

        reset() {
          this.formMeta.fields.forEach(field => {
            this.root.querySelector(`#${this.getEditorId(field.name)}`).reset();
          });

          this.extQueryCondition = {};
          if (this.queryAfterReset) {
            this.submit();
          }
        }
      }
      customElements.define(H2DomainQuery.is, H2DomainQuery);
    </script>
</dom-module>