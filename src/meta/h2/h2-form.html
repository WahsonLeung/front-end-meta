<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../behaviors/base-behavior.html">
<link rel="import" href="../behaviors/crud-behavior.html">
<dom-module id="h2-form">
    <template>
        <h2>[[formMeta.title]]</h2>
        <div>
            <template is="dom-repeat" items="{{formMeta.fields}}" as="field">
                <template is="dom-if" if="[[ isEqual(field.datatype,'action') ]]">
                    <h2-action action="[[ field.actionMeta ]]" model="[[ model ]]"></h2-action>
                </template>
                <!--text-->
                <template is="dom-if" if="[[isEqual(field.datatype,'text')]]">
                    <div>
                        <paper-input
                                id="{{ getEditorId(field.name) }}"
                                always-float-label
                                value="{{ getValueByKey(model,field.name) }}"
                                label={{field.label}}
                                auto-validate
                                required={{field.required}}
                                error-message="{{field.prompt}}"
                                min="{{field.min}}"
                                minlength="{{field.minLength}}"
                                max="{{field.max}}"
                                maxlength="{{field.maxLength}}"
                                pattern="{{field.regexp}}"
                                readonly="{{!field.editable}}"
                                type="{{field.datatype}}"
                                style="width:180px;float:left;margin: 12px;">
                        </paper-input>
                    </div>
                </template>

                <!--textarea-->
                <template is="dom-if" if="[[isEqual(field.datatype,'textarea')]]">
                    <div>
                        <paper-textarea
                                id="{{ getEditorId(field.name) }}"
                                value="{{ getValueByKey(model, field.name) }}"
                                always-float-label
                                label={{field.label}}
                                auto-validate
                                required={{field.required}}
                                error-message="{{field.prompt}}"
                                min="{{field.min}}"
                                minlength="{{field.minLength}}"
                                max="{{field.max}}"
                                maxlength="{{field.maxLength}}"
                                pattern="{{field.regexp}}"
                                readonly="{{!field.editable}}"
                                type="{{field.datatype}}"
                                style="width:180px;float:left;margin: 12px;"></paper-textarea>
                    </div>
                </template>

                <!--radio-->
                <template is="dom-if" if="[[ isEqual(field.datatype,'radio') ]]">
                    <div>
                        <paper-radio-group id="{{ getEditorId(field.name) }}"
                                           aria-labelledby="{{ getEditorId(field.name) }}" selected="1">
                            <template is="dom-repeat"
                                      items="{{ getValueByKey(model, field.itemsField, '[]') }}"
                                      as="radioItem">
                                <paper-radio-button name="[[ getValueByKey(radioItem,field.valueField) ]]">
                                    [[ getValueByKey(radioItem, field.displayField) ]]
                                </paper-radio-button>
                            </template>
                        </paper-radio-group>
                    </div>
                </template>

                <!--select-->
                <template is="dom-if" if="[[ isEqual(field.datatype,'select') ]]">
                    <div>
                        <paper-dropdown-menu id="{{ getEditorId(field.name) }}"
                                             always-float-label
                                             required="{{field.required}}"
                                             error-message="{{field.prompt}}"
                                             label="{{field.label}}"
                                             style="float:left;margin: 12px;">
                            <paper-listbox slot="dropdown-content" selected="0">
                                <template is="dom-repeat"
                                          items="{{ getValueByKey(model, field.itemsField, '[]') }}"
                                          as="selectItem">
                                    <paper-item>
                                        [[ getValueByKey(selectItem, field.displayField) ]]
                                    </paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>
                </template>

            </template>
        </div>

        <div class="buttons">
            <paper-button raised on-click="submit">保存</paper-button>
            <paper-button raised dialog-dismiss>关闭</paper-button>
        </div>
    </template>
    <script>
      class H2Form extends Polymer.mixinBehaviors([BaseBehavior, CrudBehavior], Polymer.Element) {
        constructor() {
          super();
          this.valueAccessors = this._getValueAccessors();
        }

        static get is() {
          return "h2-form";
        }

        get ignoreDateTypes() {
          return ['action'];
        }

        getEditorId(fieldName) {
          return `${this.constructor.is}-${fieldName}-editor`;
        }

        static get properties() {
          return {
            model: {
              type: Object
            },
            formMeta: {
              type: Object
            }
          }
        }

        submit() {
          if (!this._validate()) return;

          const _submit = () => {
            const param = this._requestBody();
            console.log(param);
            this.update(this.formMeta.formUrl, param, (data) => {
              console.log(data);
              this.dispatchEvent(new CustomEvent("form-submitted"));
            });
          };

          if (this.formMeta.confirm) {
            if (window.confirm(this.formMeta.confirm)) {
              _submit();
            }
          } else {
            _submit();
          }
        }

        _validate() {
          // return true if there's no field
          if (!this.formMeta.fields || this.formMeta.fields.length == 0) return true;

          return this.formMeta.fields
              .filter(field => this.ignoreDateTypes.indexOf(field.datatype) == -1)
              .every(field => {
                const editor = this.root.querySelector(`#${this.getEditorId(field.name)}`);
                // if the editor does not have a validator,return true
                return editor.validate ? editor.validate() : true;
              });
        }


        _requestBody() {
          const requestBody = {};
          this.formMeta.fields
              .filter(field => this.ignoreDateTypes.indexOf(field.datatype) == -1)
              .forEach(field => {
                requestBody[field.name] = this.valueAccessors(field.datatype)(field);
              });

          return requestBody;
        }

        _getEditor(fieldName) {
          return this.root.querySelector(`#${this.getEditorId(fieldName)}`);
        }

        _getValueAccessors() {

          const accessors = {

            ["text"]: (field) => {
              return this._getEditor(field.name).value;
            },

            ["textarea"]: (field) => {
              return this._getEditor(field.name).value;
            },

            ["radio"]: (field) => {
              return this._getEditor(field.name).selected;
            },

            ["select"]: (field) => {
              const value = this._getEditor(field.name).value;
              const items = this.model[field.itemsField] || [];
              const displayField = field.displayField;
              for (let item of items) {
                if (item[displayField] === value) {
                  return item[field.valueField];
                }
              }
            },
            ["select-tree"]: (field) => {
              return "";
            },
            ["o-staff-picker"]: (field) => {
              return this._getEditor(field.name).bindData;
            }
          };

          return (datatype) => accessors[datatype];
        }

      }
      customElements.define(H2Form.is, H2Form);
    </script>
</dom-module>