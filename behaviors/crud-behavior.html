<script>
  CrudBehavior = {

    /**
     * GET 请求
     *
     * 例子：
     * 1. 直接传递一个包含url、data内容的对象
     *  this.query({
     *       url: '/test',
     *       data: { foo:1, bar:2 }
     *       contentType: 'json'
     *   },(data) => {
     *       console.log(data);
     *   },(err) => {
     *       console.log(err);
     *   });
     *
     * 2. 直接传递一个Request 实例
     *  const req = new Request(window.location.origin + '/test?foo=1&bar=2', {method: 'GET'});
     *  this.get(req, data => console.log(data));
     *
     * @param url
     * @param data 可选
     * @param contentType  可选，默认值是"json"， 取值范围: text|json|blob|formData|arrayBuffer
     * @param succCallback
     * @param failCallback
     */
    query({
            url = this.__throwUrlNotFoundError(),
            data = {},
            contentType = "json"
          } = {},
          succCallback,
          failCallback) {
      if (Request.prototype.isPrototypeOf(arguments[0])) {
        return this.__fetch(contentType, {url, data}, succCallback, failCallback);
      } else {
        return this.__get(contentType, {url, data}, succCallback, failCallback);
      }
    },

    /**
     * POST 请求
     * @param url
     * @param data 可选
     * @param contentType  可选，默认值是"text"， 取值范围: text|json|blob|formData|arrayBuffer
     * @param succCallback
     * @param failCallback
     * @returns {*}
     */
    post({
           url = this.__throwUrlNotFoundError(),
           data = {},
           contentType = "json"
         } = {},
         succCallback,
         failCallback) {
      if (Request.prototype.isPrototypeOf(arguments[0])) {
        return this.__fetch(contentType, {url, data}, succCallback, failCallback);
      } else {
        return this.__post(contentType, {url, data}, succCallback, failCallback);
      }
    },

    /**
     *
     * this.postFormData({
     *       url: '/test',
     *       data: new FormData()
     *   },(data) => {
     *       console.log(JSON.parse(data));
     *   },(err) => {
     *       console.log(err);
     *   });
     * post 表单数据
     * @param url
     * @param data
     * @param succCallback
     * @param failCallback
     * @returns {*}
     */
    postFormData({
                   url = this.__throwUrlNotFoundError(),
                   data = {},
                   contentType = 'json'
                 } = {},
                 succCallback,
                 failCallback) {

      let request = null;
      if (Request.prototype.isPrototypeOf(arguments[0])) {
        request = arguments[0];
      } else {
        request = new Request(window.location.origin + url, {
          method: "POST",
          credentials: "include",
          body: data,
        });
      }
      return this.__fetch(contentType, request, succCallback, failCallback);
    },


    __get(contentType, {url, data}, succCallback, failCallback) {

      if (Object.keys(data).length > 0) {
        url = `${url}?${Object.entries(data).map(entry => entry.join('=')).join('&')}`;
      }

      const req = new Request(window.location.origin + url, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include"
      });

      return this.__fetch(contentType, req, succCallback, failCallback);
    },

    __post(contentType, {url, data}, succCallback, failCallback) {
      const req = new Request(window.location.origin + url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(data),
      });

      return this.__fetch(contentType, req, succCallback, failCallback);
    },

    __fetch(contentType, request, succCallback, failCallback) {

      window.fetch(request).then(response => {
        if (response.ok) {
          // response content is blank
          if (response.headers.has('Content-length')
              && response.headers.get('Content-length') == 0) {

            succCallback && succCallback();
          } else {
            response[contentType]().then(data => {
              succCallback && succCallback(data);
            });
          }

        } else {
          response.text().then(data => {
            failCallback && failCallback(data);
          });
        }

      }).catch(err => {
        console.error(err);
      });
    },

    __throwUrlNotFoundError(){
      throw new Error("url not found");
    }

  }
</script>