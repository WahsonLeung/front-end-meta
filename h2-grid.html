<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./behaviors/base-behavior.html">
<link rel="import" href="h2-action.html">
<link rel="import" href="./widgets/h2-action-group.html">
<link rel="import" href="h2-crust.html">
<dom-module id="h2-grid">
    <template>
        <style>
            dom-repeat, dom-if {
                display: none;
            }

            :host thead {
                background: #595959;
                color: #fff;
            }
            :host th {
                text-align: left;
                height: 40px;
                font-size: 1.1em;
            }
            :host table {
                background: transparent;
                border-spacing: 0;
                border-collapse: collapse;
            }

            :host td > {
                padding: 15px;
            }

            :host tr:nth-of-type(even) {
                background-color: lightgrey;
            }

            :host td:nth-last-of-type(1) {
                display: inline;
                width: 200px;
            }

            :host .action, :host .action-group {
                margin: 10px 5px;
                width: 80px;
                height: 30px;
            }

        </style>
        <slot name="filter"></slot>
        <table width="100%">
            <thead>
            <tr>
                <template is="dom-repeat" items="[[ metadata.grids ]]">
                    <th>[[item.label]]</th>
                </template>
            </tr>
            </thead>
            <tbody>
            <template is="dom-repeat" items="[[models]]" as="model">
                <tr>
                    <template is="dom-repeat" items="[[metadata.grids]]" as="fieldMeta">
                        <td>

                            <template is="dom-if" if="[[ !isEqual(fieldMeta.datatype, 'action') ]]">
                                <h2-widget field-meta="[[fieldMeta]]"
                                           editable="[[fieldMeta.editable]]"
                                           context="[[ model ]]"
                                           value="[[ getValueByKey(model,fieldMeta.name) ]]">
                                </h2-widget>
                            </template>

                            <template is="dom-if" if="[[ isEqual(fieldMeta.datatype,'action') ]]">
                                <template is="dom-repeat" items="{{noGroupActions(model.actions)}}" as="actionMeta">
                                    <h2-action class="action"
                                               action-meta="[[ actionMeta ]]"
                                               model="[[ model ]]">
                                    </h2-action>
                                </template>
                                <template is="dom-repeat" items="{{ groupedActions(model.actions) }}">
                                    <h2-action-group
                                            class="action-group"
                                            name="[[ item.group ]]">
                                        <template is="dom-repeat" items="[[ item.actions ]]" as="actionMeta">
                                            <h2-action action-meta="[[ actionMeta ]]"
                                                       model="[[ model ]]">
                                            </h2-action>
                                        </template>
                                    </h2-action-group>
                                </template>
                            </template>
                        </td>
                    </template>
                </tr>
            </template>
            </tbody>
        </table>
    </template>
    <script>
      class H2Grid extends Polymer.mixinBehaviors([BaseBehavior], Polymer.Element) {
        constructor() {
          super();
        }

        static get is() {
          return "h2-grid";
        }

        static get properties() {
          return {
            editable: {
              type: Boolean,
              value: false
            },
            models: {
              type: Array,
            },
            metadata: {
              type: Object,
            }
          }
        }

        groupedActions(actions) {
          const groupedActions = [];
          const groupMap = {};
          actions.map(actionId => {
            const meta = this.getValueByKey(this.metadata.actions, actionId);
            const grp = meta.group;
            if (grp) {
              groupMap[grp] = groupMap[grp] || [];
              groupMap[grp].push(meta);
            }
          });
          for (let grp in groupMap) {
            groupedActions.push({group: grp, actions: groupMap[grp]});
          }
          return groupedActions;
        }

        noGroupActions(actions) {
          return actions.filter(actionId => {
            const meta = this.getValueByKey(this.metadata.actions, actionId);
            const grp = meta.group;
            return !grp;
          }).map(actionId => this.getValueByKey(this.metadata.actions, actionId));
        }
      }

      customElements.define(H2Grid.is, H2Grid);
    </script>
</dom-module>