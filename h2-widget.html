<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./widgets/h2-widget-base.html">
<link rel="import" href="./behaviors/base-behavior.html">

<dom-module id="h2-widget">
    <template>
        <div id="slot"></div>
    </template>
    <script>
      class H2Widget extends Polymer.mixinBehaviors([BaseBehavior], H2WidgetBase) {
        static get is() {
          return "h2-widget";
        }

        static get properties() {
          return {
            editable: {
              type: Boolean,
              value: false
            },
            readonlyTemplate: {
              type: String,
              value: 'h2-crust'
            },

            widgetRef: {
              type: Object
            }
          };
        }

        static get observers() {
          return [
            '__metadataChange(metadata)',
            '__valueChange(value)'
          ];
        }

        validate() {
          const ele = this.widgetRef;
          return ele && ele.validate && ele.validate();
        }

        __metadataChange() {
          if (this.editable) {
            const tagName = this.metadata.element || H2Widget.defaultElements[this.metadata.datatype];
            const eleDom = document.createElement(tagName);
            eleDom.addEventListener("value-changed", (e) => {
              e.stopPropagation();
              this.value = eleDom.value;
            });
            eleDom.context = this.context;

            if (this.metadata.dataTypeExtra) {
              // TODO
              // fetch metadata with dataTypeExtra,
              // but the metadata service doesn't work yet,
              // so currently get metadata from this.metadata instead
              eleDom.metadata = this.metadata.metadata;
            } else {
              eleDom.metadata = this.metadata;
            }

            this.widgetRef = this.$.slot.appendChild(eleDom);
          } else {

            const element = this.elementRender(this.context, this.metadata);
            this.$.slot.innerHTML = element;
          }

        }


        __valueChange() {
          const target = this.widgetRef;

          target && (target.value = this.value);
          this.context && (this.context[this.metadata.name] = this.value);

          if (!this.editable) {
            const element = this.elementRender(this.context, this.metadata);
            this.$.slot.innerHTML = element;
          }
        }

        static get defaultElements() {
          return {
            'text': 'h2-text',
            'textarea': 'h2-text-area',
            'number': 'h2-number',
            'date': 'h2-date',
            'select-list': 'h2-select-list',
            'select-tree': 'h2-select-tree',
            'radio-group': 'h2-radio-group'
          };
        }
      }

      customElements.define(H2Widget.is, H2Widget);
    </script>
</dom-module>